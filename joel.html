<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma de Atividades | Joel Francisco Borges</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .sticky-header { backdrop-filter: blur(8px); background-color: rgba(255, 255, 255, 0.9); }
        .item-row:hover { background-color: #f1f5f9; }
        .loader { border-top-color: #3b82f6; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom Scrollbar para Timeline */
        .custom-scrollbar::-webkit-scrollbar { height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .view-btn.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(79 70 229 / 0.2);
        }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <header class="sticky top-0 z-50 w-full border-b border-slate-200 sticky-header">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg text-white shadow-md shadow-indigo-100">
                    <i data-lucide="calendar-check"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-900 leading-tight">Painel de Acompanhamento</h1>
                    <p class="text-xs text-slate-500 font-medium uppercase tracking-wider">Joel Francisco Borges</p>
                </div>
            </div>

            <!-- Alternador de Visualização -->
            <div class="flex bg-slate-100 p-1 rounded-xl border border-slate-200">
                <button onclick="changeView('list')" id="btn-list" class="view-btn active flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold transition-all">
                    <i data-lucide="list" class="w-4 h-4"></i> <span class="hidden sm:inline">Lista</span>
                </button>
                <button onclick="changeView('grid')" id="btn-grid" class="view-btn flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold transition-all">
                    <i data-lucide="layout-grid" class="w-4 h-4"></i> <span class="hidden sm:inline">Galeria</span>
                </button>
                <button onclick="changeView('timeline')" id="btn-timeline" class="view-btn flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold transition-all">
                    <i data-lucide="clock" class="w-4 h-4"></i> <span class="hidden sm:inline">Timeline</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Dashboard de Resumo -->
        <div id="stats-container" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-10"></div>

        <!-- Feedback Visual -->
        <div id="status-message" class="flex flex-col items-center justify-center py-24 text-slate-500">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-12 w-12 mb-4"></div>
            <p class="animate-pulse font-medium">Sincronizando dados...</p>
        </div>

        <!-- Área de Conteúdo Dinâmico -->
        <div id="main-content" class="hidden"></div>
    </main>

    <footer class="border-t border-slate-200 bg-white py-10 mt-20">
        <div class="container mx-auto px-4 text-center">
            <p class="text-sm text-slate-400 font-medium italic">
                Dados atualizados via Cloud Sync • Google Sheets Integration
            </p>
        </div>
    </footer>

    <script>
        const CONFIG = {
            CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRbGTMwjYj7m8CorXDXCvMYZMVTWzpsmUUa3xPxVaU6KQPduxg17Yo0jH7PWPTudXNp2tiidRHR5Dtw/pub?output=csv'
        };

        let APP_STATE = {
            data: [],
            currentView: 'list' // list, grid, timeline
        };

        // Normalização de chaves e dados
        function normalizeKey(key) {
            return key.toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/\s+/g, '_')
                .replace(/^n$/, 'numero')
                .replace('checkbox', 'check')
                .trim();
        }

        function isDone(val) {
            return ['true', 'x', '1', 'sim'].includes(String(val).toLowerCase());
        }

        // Parser de datas flexível
        function parseDate(dateStr) {
            if (!dateStr || dateStr.toLowerCase().includes('prazo')) return null;
            // Extrai a última data se for um intervalo (ex: 21-28/01/2026 -> 28/01/2026)
            const parts = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/g);
            if (parts && parts.length > 0) {
                const [d, m, y] = parts[parts.length - 1].split('/');
                return new Date(y, m - 1, d);
            }
            return null;
        }

        function parseCSV(csvText) {
            const rows = [];
            const lines = csvText.split(/\r?\n/);
            if (lines.length < 2) return [];

            const headers = lines[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(h => normalizeKey(h.replace(/^"|"$/g, '')));

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const rowObj = {};
                headers.forEach((header, index) => {
                    let val = values[index] ? values[index].replace(/^"|"$/g, '').trim() : '';
                    rowObj[header] = val;
                });
                // Helpers de exibição
                rowObj._done = isDone(rowObj.check);
                rowObj._date = parseDate(rowObj.data_prevista || rowObj.data_prevista);
                rows.push(rowObj);
            }
            return rows;
        }

        async function initApp() {
            try {
                const response = await fetch(`${CONFIG.CSV_URL}&cache=${Date.now()}`);
                const csvData = await response.text();
                APP_STATE.data = parseCSV(csvData);
                
                document.getElementById('status-message').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                
                renderStats();
                renderCurrentView();
            } catch (error) {
                console.error(error);
                showError("Não foi possível carregar os dados.");
            }
        }

        function changeView(view) {
            APP_STATE.currentView = view;
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${view}`).classList.add('active');
            renderCurrentView();
        }

        function renderCurrentView() {
            const container = document.getElementById('main-content');
            container.innerHTML = '';

            if (APP_STATE.currentView === 'list') renderListView(container);
            else if (APP_STATE.currentView === 'grid') renderGridView(container);
            else if (APP_STATE.currentView === 'timeline') renderTimelineView(container);
            
            lucide.createIcons();
        }

        // --- VISUALIZAÇÃO EM LISTA (Original Refinada) ---
        function renderListView(container) {
            const grouped = APP_STATE.data.reduce((acc, item) => {
                const f = item.fase || 'Outros';
                if (!acc[f]) acc[f] = [];
                acc[f].push(item);
                return acc;
            }, {});

            Object.entries(grouped).forEach(([fase, itens]) => {
                const section = document.createElement('div');
                section.className = 'mb-12';
                section.innerHTML = `
                    <h2 class="text-2xl font-black text-slate-800 mb-6 border-b pb-2 flex items-center gap-3">
                        <span class="w-2 h-8 bg-indigo-600 rounded-full"></span> ${fase.toUpperCase()}
                    </h2>
                    <div class="space-y-3">
                        ${itens.map(i => renderItemRow(i)).join('')}
                    </div>
                `;
                container.appendChild(section);
            });
        }

        function renderItemRow(item) {
            return `
                <div class="bg-white border ${item._done ? 'border-slate-100' : 'border-slate-200'} p-4 rounded-xl flex items-center gap-4 hover:shadow-sm transition-all">
                    <div class="w-8 h-8 rounded-lg ${item._done ? 'bg-emerald-50 text-emerald-600' : 'bg-slate-50 text-slate-400'} flex items-center justify-center text-xs font-bold border border-slate-100">
                        ${item.numero || item.n || '?'}
                    </div>
                    <div class="flex-1">
                        <p class="text-[9px] font-bold text-indigo-500 uppercase">${item.etapa || 'Etapa'}</p>
                        <h3 class="font-semibold text-slate-800 ${item._done ? 'line-through text-slate-400' : ''}">${item.descricao || item.descrição}</h3>
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] font-bold text-slate-400 uppercase">Previsão</p>
                        <p class="text-xs font-bold text-slate-600">${item.data_prevista || '-'}</p>
                    </div>
                </div>
            `;
        }

        // --- VISUALIZAÇÃO EM GRADE (Galeria) ---
        function renderGridView(container) {
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6';
            
            grid.innerHTML = APP_STATE.data.map(item => `
                <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm hover:shadow-md transition-all flex flex-col justify-between relative overflow-hidden">
                    ${item._done ? '<div class="absolute top-0 right-0 bg-emerald-500 text-white px-3 py-1 text-[10px] font-bold rounded-bl-xl uppercase">Concluído</div>' : ''}
                    <div>
                        <div class="flex items-center gap-2 mb-4">
                            <span class="text-[10px] font-bold px-2 py-0.5 bg-slate-100 text-slate-500 rounded uppercase tracking-tight">${item.fase}</span>
                        </div>
                        <h3 class="font-bold text-slate-900 leading-tight mb-2">${item.descricao || item.descrição}</h3>
                        <p class="text-sm text-slate-500 line-clamp-2">${item.etapa || ''}</p>
                    </div>
                    <div class="mt-6 pt-4 border-t border-slate-100 flex items-center justify-between">
                        <div class="flex items-center gap-2 text-slate-400">
                            <i data-lucide="calendar" class="w-3.5 h-3.5"></i>
                            <span class="text-xs font-bold">${item.data_prevista}</span>
                        </div>
                        <span class="text-xs font-black text-slate-300">#${item.numero}</span>
                    </div>
                </div>
            `).join('');
            container.appendChild(grid);
        }

        // --- VISUALIZAÇÃO EM TIMELINE (Panorâmica) ---
        function renderTimelineView(container) {
            const validItems = APP_STATE.data.filter(i => i._date).sort((a, b) => a._date - b._date);
            if (validItems.length === 0) {
                container.innerHTML = '<p class="text-center py-10 text-slate-400 font-medium">Datas não formatadas para gerar Timeline.</p>';
                return;
            }

            const startDate = new Date(validItems[0]._date);
            startDate.setDate(1); // Início do mês
            const endDate = new Date(validItems[validItems.length - 1]._date);
            endDate.setMonth(endDate.getMonth() + 1); // Fim do período

            const totalMs = endDate - startDate;
            const timelineWidth = Math.max(container.offsetWidth, 1200);

            const timelineWrapper = document.createElement('div');
            timelineWrapper.className = 'bg-white border border-slate-200 rounded-3xl p-8 shadow-sm overflow-x-auto custom-scrollbar';
            
            // Gerador de Meses no topo
            let monthsHtml = '';
            let current = new Date(startDate);
            while (current < endDate) {
                const left = ((current - startDate) / totalMs) * 100;
                monthsHtml += `
                    <div class="absolute top-0 border-l border-slate-200 h-full pl-2" style="left: ${left}%">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${current.toLocaleDateString('pt-BR', {month: 'short', year: '2-digit'})}</span>
                    </div>
                `;
                current.setMonth(current.getMonth() + 1);
            }

            // Gerador de Pontos
            const pointsHtml = validItems.map((item, idx) => {
                const left = ((item._date - startDate) / totalMs) * 100;
                const offset = (idx % 3) * 40; // Desenpila verticalmente
                return `
                    <div class="absolute group cursor-pointer" style="left: ${left}%; top: ${80 + offset}px">
                        <div class="w-4 h-4 rounded-full ${item._done ? 'bg-emerald-500' : 'bg-indigo-600'} border-4 border-white shadow-sm hover:scale-125 transition-transform"></div>
                        <!-- Tooltip -->
                        <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block w-48 z-10">
                            <div class="bg-slate-900 text-white text-[10px] p-3 rounded-lg shadow-xl">
                                <p class="font-bold opacity-70 mb-1">${item.data_prevista}</p>
                                <p class="font-medium">${item.descricao}</p>
                            </div>
                            <div class="w-2 h-2 bg-slate-900 rotate-45 mx-auto -mt-1"></div>
                        </div>
                    </div>
                `;
            }).join('');

            timelineWrapper.innerHTML = `
                <div class="relative" style="width: ${timelineWidth}px; min-height: 260px;">
                    <div class="absolute top-10 left-0 w-full h-px bg-slate-200"></div>
                    ${monthsHtml}
                    <div class="absolute top-10 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-indigo-300 rounded-full mt-24 opacity-10"></div>
                    ${pointsHtml}
                </div>
            `;
            container.appendChild(timelineWrapper);
        }

        function renderStats() {
            const total = APP_STATE.data.length;
            const done = APP_STATE.data.filter(i => i._done).length;
            const perc = Math.round((done / total) * 100) || 0;

            document.getElementById('stats-container').innerHTML = `
                <div class="bg-white p-6 rounded-2xl border border-slate-200">
                    <p class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Status</p>
                    <p class="text-3xl font-black text-slate-900">${perc}% <span class="text-xs text-slate-400 font-bold uppercase tracking-tight">Fiel</span></p>
                </div>
                <div class="bg-white p-6 rounded-2xl border border-slate-200">
                    <p class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Concluído</p>
                    <p class="text-3xl font-black text-emerald-600">${done} <span class="text-xs text-slate-400 font-bold uppercase tracking-tight">/ ${total}</span></p>
                </div>
                <div class="bg-white p-6 rounded-2xl border border-slate-200">
                    <p class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Próximo Marco</p>
                    <p class="text-sm font-bold text-slate-700 truncate">${APP_STATE.data.find(i => !i._done)?.descricao || 'Nenhum'}</p>
                </div>
            `;
        }

        function showError(msg) {
            document.getElementById('status-message').innerHTML = `<p class="text-red-500 font-bold">${msg}</p>`;
        }

        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
